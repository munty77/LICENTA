<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart Page</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link rel="stylesheet" href="style_home.css"> 
    <link rel="stylesheet" href="style_subnav.css">
    <style>
        p{
            font-size: 13px;
            margin-top: 1px;
        }
    </style>
</head>
<body>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-auth.js";
        import {getDatabase, ref, set, get, child, update, remove} from "https://www.gstatic.com/firebasejs/9.8.1/firebase-database.js"

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4QbCtMwmAygKrUaubiIHyHzgHTxYRzxs",
            authDomain: "test-autentificare.firebaseapp.com",
            databaseURL: "https://test-autentificare-default-rtdb.firebaseio.com",
            projectId: "test-autentificare",
            storageBucket: "test-autentificare.appspot.com",
            messagingSenderId: "297047922567",
            appId: "1:297047922567:web:1ec8c6da201fe836c56522"
        };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();

        /////**************************/////
        
        const uid = sessionStorage.getItem("uid");
        console.log("UID logat");
        console.log(uid);
        const db = getDatabase();
        const dbRef = ref(db);
        get(child(dbRef, "Conturi/" + uid))
        .then((snapshot) => {
            if (snapshot.exists()) {
                const displayName = snapshot.val().Nume;
                console.log(displayName);
                const username =  snapshot.val().Utilizator;
                console.log(username);
                if(username == ''){
                    const user_db = document.getElementById('user-db');
                    user_db.innerHTML = displayName;
                }else{
                    const user_db = document.getElementById('user-db');
                    user_db.innerHTML = username;
                }
            } else {
                console.log("No data available");
            }
        })
        .catch((error) => {
            console.error(error);
        });
        /////**************************/////

        document.getElementById("signout").addEventListener('click', () => {
            signOut(auth)
            .then(()=>{
                console.log("Utilizatorul a fost deconectat");
                window.location.replace("form_login.html");
            })
            .catch((error)=>{
                console.log(error);
            })
        });
    
        ///////////////////////////////////
        var subPlata = document.getElementById("subtotalPlata");
            subPlata.innerHTML = 0;
        var transport = document.getElementById("transport");
        var totalPlata = document.getElementById("totalPlata"); 
        var cartKeys = [];

        var tbody = document.getElementById('tbody-cart');
        // FUNTIE PENTRU GENERAREA DINAMICA A PRODUSELOR DIN COSUL DE CUMPARATURI     
        function AddItem(key, childKey, imagine, culoare, brand, denumire, pret, marime, cantitate, subtotal){

            let tr = document.createElement('tr');
                tr.id = "tr-" + key;
            let tdDelete = document.createElement('td');//x-sterge
            let tdImage = document.createElement('td');//imagine
            let tdColor = document.createElement('td');//culoare
            let tdBrand = document.createElement('td');//brand
            let tdName = document.createElement('td');//denumire
            let tdPrice = document.createElement('td');//pret
            let tdSize = document.createElement('td');//marime
            let tdQuantity = document.createElement('td');//cantitate
            let tdSubtotal = document.createElement('td');//subtotal
            let tdView = document.createElement('td');//vizualizare

            tdDelete.innerHTML = '<a id="dlt' + childKey + '"><i class="fas fa-times-circle del"></i></a>';
            tdImage.innerHTML = '<img src="' + imagine + '">';
            tdColor.innerHTML = '<img src="' + culoare + '">';
            tdBrand.innerHTML = brand;
            tdName.innerHTML = denumire;
            tdPrice.innerHTML = pret + " lei";
            tdSize.innerHTML = marime;
            tdQuantity.innerHTML = '<input id="nr' + key + '" type="number" value="' + cantitate + '" min="1">';
            tdSubtotal.innerHTML = subtotal + " lei";
            tdView.innerHTML = '<a id="view' + key + '"><i class="fas fa-eye eye"></i></a>';

            console.log("KEY PROD === " + key);

            tr.appendChild(tdDelete);
            tr.appendChild(tdImage);
            tr.appendChild(tdColor);
            tr.appendChild(tdBrand);
            tr.appendChild(tdName);
            tr.appendChild(tdPrice);
            tr.appendChild(tdSize);
            tr.appendChild(tdQuantity);
            tr.appendChild(tdSubtotal);
            tr.appendChild(tdView);

            tbody.appendChild(tr);
            
            
            let previous_value = document.getElementById("nr" + key).value;
            console.log("PREVIOUS VALUE 1 === " + previous_value);
            document.getElementById("nr" + key).addEventListener('change', () => {
                get(child(dbRef, "Conturi/" + uid + "/CosCumparaturi/" + key)).then((snapshot) => {
                    snapshot.forEach(function(childObject){
                        console.log("CHILD KEY: " + childObject.key);
                        let child = childObject.key;


                        let value = document.getElementById("nr" + key).value; 
                        console.log("  "); 
                        console.log(" VALUE  === " + value);
                        console.log("PREVIOUS VALUE 2 === " + previous_value); 
                        console.log("  ");
                        

                        // cantitatea
                        var nr = document.getElementById("nr" + key).value;
                        // subtotalul => pret * cantitate
                        var subtotal2 = parseFloat(pret*nr).toFixed(2);
                        tdSubtotal.innerHTML = subtotal2 + " lei";

                        if (previous_value > value) {
                            console.log("Decreased");
                            subPlata.innerHTML =  parseInt(subPlata.innerHTML) - parseInt(pret);
                        } else if (previous_value < value) {
                            console.log("Increased");
                            subPlata.innerHTML =  parseInt(subPlata.innerHTML) + parseInt(pret);
                        }
                        previous_value = value;

                        console.log("  ");
                        console.log("SubPlata: " + subPlata.innerHTML);
                        sessionStorage.setItem("subPlata", subPlata.innerHTML);

                        totalPlata.innerHTML = parseInt(subPlata.innerHTML) + parseInt(transport.innerHTML); 

                    
                        update(ref(db, "Conturi/" +  uid + "/CosCumparaturi/" + key + "/" + child), {
                            Cantitate: nr,
                            Subtotal: subtotal2
                        })
                        .then(()=>{
                            console.log("Datele au fost actualizate");
                            //window.location.reload(true);
                        })
                        .catch((error)=>{
                            console.log(error);
                        })
                    })
                })
            });

            if(document.getElementById("dlt" + childKey)){
                document.getElementById("dlt" + childKey).addEventListener('click', () => {
                    console.log("delete");
                    remove(ref(db, "Conturi/" + uid + "/CosCumparaturi/" + key + "/" + childKey))
                    .then(() => {
                        alert("Produsul a fost sters din cosul de cumparaturi!");
                        document.getElementById("tr-" + key).remove();
                    })
                    .catch((error) => {
                        alert("Eroare: " + error);
                    })
                })
            }
            
            
            document.getElementById("view" + key).addEventListener('click', () => {
                sessionStorage.setItem("keyProd", key);
                sessionStorage.setItem("image1", imagine);

                window.location.href = "/form_details.html";
            })

            console.log("Utilizatorul a cumparat acest produs: " + key); 
        }


        function AddAllItems(ProdCart){
            tbody.innerHTML = "";
            ProdCart.forEach(element => {
                get(child(dbRef, "Conturi/" + uid + "/CosCumparaturi/" + element.key)).then((snapshot) => {
                    snapshot.forEach(function(child){
                        
                        console.log("CHILD KEY: " + child.key);
                        console.log("KEY == " + element.key);
                        let poza = child.val().Poza;
                        let culoare = child.val().Culoare;
                        let brand = child.val().Brand;
                        let nume = child.val().Nume;
                        let pret;
                        if(child.val().PretRedus != 0){
                            pret = child.val().PretRedus;
                            console.log("PRET REDUS == " + pret);
                        }else{
                            pret = child.val().Pret;
                            console.log("PRET == " + pret);
                        }
                        
                       
                        let marime = child.val().Marime
                        let cantitate = child.val().Cantitate;
                        let subtotal = child.val().Subtotal;
                        

                        console.log("Brand: " + brand);
                        console.log("Subtotal: " + subtotal);
                        console.log("Cantitate: " + cantitate);

                        AddItem(element.key, child.key, poza, culoare, brand, nume, pret, marime, cantitate, subtotal)
                        

                        subPlata.innerHTML =  parseInt(subPlata.innerHTML) + parseInt(subtotal);
                        console.log("  ");
                        console.log("SubPlata: " + subPlata.innerHTML);
                        sessionStorage.setItem("subPlata", subPlata.innerHTML);
                        
                        totalPlata.innerHTML = parseInt(subPlata.innerHTML) + parseInt(transport.innerHTML); 
                    })
                })
                .catch((error) => {
                    console.log("Mesaj eroare " + error);
                })
                
            })
        }
        
       
        function GetAllData(){
            const dbRef = ref(db);
            get(child(dbRef, "Conturi/" + uid + "/CosCumparaturi/"))
            .then((snapshot) => {
                var prod = [];
                snapshot.forEach(childSnapshot => {
                    console.log("Child -> id-urile produselor:");
                    console.log(childSnapshot.key);
                    prod.push(childSnapshot);
                });
                AddAllItems(prod);
            })
            .catch((error) => {
                console.log("Mesaj eroare " + error);
            })
        }
        window.onload = GetAllData;
    
    
        document.getElementById("send").addEventListener('click', () => {
            window.location.href = "form_checkout.html";
        })
    </script>

    <section id="header">
        <a href="form_home.html"><img src="img/home_logo.jpg" class="logo" alt=""></a>
        <div>
            <ul id="navbar">
                <li><a href="form_home.html">Acasa</a></li>
                <li><a href="form_products.html">Produse</a></li>
                <li><a href="form_about.html">Despre</a></li>
                <li><a href="form_contact.html">Contact</a></li>
                <ul class="subnav">
                    <li><a class="active"><i class="fa fa-shopping-bag"></i> <i id="sub-1" class="fa fa-caret-down"></i></a></li>
                    <ul id="drop-1">
                        <li><i class="fas fa-heart"></i></li>
                        <li><a href="form_favorite.html">Produse Favorite</a></li>
                        <li><a class="active" href="form_cart.html">Cos cumparaturi</a></li>
                    </ul>
                </ul>
                
                <ul class="subnav">
                    <li><a id="signoutlink" class="nav-link"><i class="fas fa-user"></i> <i id="sub" class="fa fa-caret-down"></i></a></li>
                    <ul id="drop">
                        <li><label id="user-db">-</label></li>
                        <li><a href="form_profile.html">Editare Profil</a></li>
                        <li><a id="signout" href="form_logare.html">Deconectare</a></li>
                    </ul>
                </ul>
                <a href="#" id="close"><i class="fas fa-times-circle"></i></a>
            </ul>
        </div>
        <div id="mobile">
            <i id="bar" class="fas fa-bars"></i>
        </div>
    </section>
    <!-- script for responsive menu -->
    <script src="scriptHome.js"></script>
    <script src="scriptSubnav.js"></script>

    <section id="header-banner-cart">
        <h1><span>#shopwithus</span></h1>
    </section>

    <section id="cart" class="section-p1">
        <table width="100%">
            <thead>
                <tr>
                    <td>Sterge</td>
                    <td>Imagine</td>
                    <td>Culoare</td>
                    <td>Brand</td>
                    <td>Denumire</td>
                    <td>Pret</td>
                    <td>Marime</td>
                    <td>Cantitate</td>
                    <td>Subtotal</td>
                    <td>Detalii</td>
                </tr>
            </thead>
            <tbody id="tbody-cart">
                <!-- cod generat -->
            </tbody>
        </table>
    </section>

    <section id="cart-add" class="section-p1">
        <div></div>
        <div id="subtotal">
            <h3>Nota de Plata</h3>
            <!-- <p>Daca suma depaseste 200 lei transportul este gratuit.</p> -->
            <table>
                <tr>
                    <td>Subtotal</td>
                    <td id="subtotalPlata">-</td>
                </tr>
                <tr>
                    <td>Transport (poate varia in functie de metoda de expediere)</td>
                    <td id="transport">19</td>
                </tr>
                <tr>
                    <td><strong>Total</strong></td>
                    <td id="totalPlata"><strong>-</strong></td>
                </tr>
            </table>
            <button id="send" class="normal">Finalizare cumparaturi</button>
        </div>
    </section>


    <footer class="section-p1">
        <div class="col">
            <img class="logof" src="img/home_logo.jpg" alt="">
            <p>I was sad but then I bought something online.<br>I feel better now.</p>
            <h4>Follow Us</h4>
            <div class="icon">
                <a href="https://www.facebook.com/"><i class="fab fa-facebook fb"></i></a>
                <a href="https://www.instagram.com/"><i class="fab fa-instagram ig"></i></a>
                <a href="https://www.snapchat.com/"><i class="fab fa-snapchat sc"></i></a>
                <a href="https://twitter.com/?lang=ro"><i class="fab fa-twitter tw"></i></a>
            </div>
        </div>
    </footer>
</body>
</html>